import{observe as q,onAdd as ee,onRemove as te,query as re,addComponent as ne,hasComponent as ie,removeComponent as oe}from"bitecs";import{addComponent as w,removeComponent as Q,addEntity as N,removeEntity as H,observe as v,onAdd as B,onRemove as $,entityExists as J,isRelation as K,getRelationTargets as X,Wildcard as E}from"bitecs";var b=Symbol.for("bitecs-u8"),A=Symbol.for("bitecs-i8"),I=Symbol.for("bitecs-u16"),T=Symbol.for("bitecs-i16"),f=Symbol.for("bitecs-u32"),C=Symbol.for("bitecs-i32"),g=Symbol.for("bitecs-f32"),R=Symbol.for("bitecs-f64"),x=e=>(t=[])=>Object.defineProperty(t,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),ye=x(b),se=x(A),pe=x(I),ue=x(T),me=x(f),le=x(C),ce=x(g),de=x(R),h={[b]:(e,t,i)=>(e.setUint8(t,i),1),[A]:(e,t,i)=>(e.setInt8(t,i),1),[I]:(e,t,i)=>(e.setUint16(t,i),2),[T]:(e,t,i)=>(e.setInt16(t,i),2),[f]:(e,t,i)=>(e.setUint32(t,i),4),[C]:(e,t,i)=>(e.setInt32(t,i),4),[g]:(e,t,i)=>(e.setFloat32(t,i),4),[R]:(e,t,i)=>(e.setFloat64(t,i),8)},S={[b]:(e,t)=>({value:e.getUint8(t),size:1}),[A]:(e,t)=>({value:e.getInt8(t),size:1}),[I]:(e,t)=>({value:e.getUint16(t),size:2}),[T]:(e,t)=>({value:e.getInt16(t),size:2}),[f]:(e,t)=>({value:e.getUint32(t),size:4}),[C]:(e,t)=>({value:e.getInt32(t),size:4}),[g]:(e,t)=>({value:e.getFloat32(t),size:4}),[R]:(e,t)=>({value:e.getFloat64(t),size:8})};function z(e){return e&&(ArrayBuffer.isView(e)||Array.isArray(e)&&typeof e=="object")}function D(e){for(let t of[b,A,I,T,f,C,g,R])if(t in e)return t;return e instanceof Int8Array?A:e instanceof Uint8Array?b:e instanceof Int16Array?T:e instanceof Uint16Array?I:e instanceof Int32Array?C:e instanceof Uint32Array?f:e instanceof Float32Array?g:R}var L=e=>{if(z(e)){let y=D(e),o=h[y];return(n,a,s)=>{let p=0;return p+=h[f](n,a,s),p+=o(n,a+p,e[s]),p}}let t=Object.keys(e),r=t.map(y=>{let o=e[y];if(!z(o))throw new Error(`Invalid array type for property ${y}`);return D(o)}).map(y=>h[y]||(()=>{throw new Error("Unsupported or unannotated type")}));return(y,o,n)=>{let a=0;a+=h[f](y,o+a,n);for(let s=0;s<t.length;s++)a+=r[s](y,o+a,e[t[s]][n]);return a}},G=e=>{if(z(e)){let y=D(e),o=S[y];return(n,a,s)=>{let p=0,{value:u,size:m}=S[f](n,a);p+=m;let l=s?s.get(u)??u:u,{value:c,size:W}=o(n,a+p);return e[l]=c,p+W}}let t=Object.keys(e),r=t.map(y=>{let o=e[y];if(!z(o))throw new Error(`Invalid array type for property ${y}`);return D(o)}).map(y=>S[y]||(()=>{throw new Error("Unsupported or unannotated type")}));return(y,o,n)=>{let a=0,{value:s,size:p}=S[f](y,o+a);a+=p;let u=n?n.get(s)??s:s;for(let m=0;m<t.length;m++){let{value:l,size:c}=r[m](y,o+a);e[t[m]][u]=l,a+=c}return a}},O=(e,t=new ArrayBuffer(1024*1024*100))=>{let i=new DataView(t),r=e.map(L);return y=>{let o=0;for(let n=0;n<y.length;n++){let a=y[n];for(let s=0;s<r.length;s++)o+=r[s](i,o,a)}return t.slice(0,o)}},P=e=>{let t=e.map(G);return(i,r)=>{let y=new DataView(i),o=0;for(;o<i.byteLength;)for(let n=0;n<t.length;n++)o+=t[n](y,o,r)}};function Y(e,t,i,r){if(!e)return r;if(Array.isArray(e)){let y=e[t];return y!==void 0?(i.setFloat64(r,y),r+8):r}if(typeof e=="object"){let y=Object.keys(e).sort();for(let o of y){let n=e[o],a=n[t];a!==void 0&&(n instanceof Int8Array||A in n?(i.setInt8(r,a),r+=1):n instanceof Uint8Array||b in n?(i.setUint8(r,a),r+=1):n instanceof Int16Array||T in n?(i.setInt16(r,a),r+=2):n instanceof Uint16Array||I in n?(i.setUint16(r,a),r+=2):n instanceof Int32Array||C in n?(i.setInt32(r,a),r+=4):n instanceof Uint32Array||f in n?(i.setUint32(r,a),r+=4):n instanceof Float32Array||g in n?(i.setFloat32(r,a),r+=4):(i.setFloat64(r,a),r+=8))}}return r}function Z(e,t,i,r){if(!e)return r;if(Array.isArray(e))return e[t]=i.getFloat64(r),r+8;if(typeof e=="object"){let y=Object.keys(e).sort();for(let o of y){let n=e[o];n instanceof Int8Array||A in n?(n[t]=i.getInt8(r),r+=1):n instanceof Uint8Array||b in n?(n[t]=i.getUint8(r),r+=1):n instanceof Int16Array||T in n?(n[t]=i.getInt16(r),r+=2):n instanceof Uint16Array||I in n?(n[t]=i.getUint16(r),r+=2):n instanceof Int32Array||C in n?(n[t]=i.getInt32(r),r+=4):n instanceof Uint32Array||f in n?(n[t]=i.getUint32(r),r+=4):n instanceof Float32Array||g in n?(n[t]=i.getFloat32(r),r+=4):(n[t]=i.getFloat64(r),r+=8)}}return r}var V=(e,t,i,r=new ArrayBuffer(1024*1024*100))=>{let y=new DataView(r),o=0,n=[],a=new Map;return v(e,B(t),s=>{n.push([s,0,-1])}),v(e,$(t),s=>{n.push([s,1,-1]),a.delete(s)}),i.forEach((s,p)=>{K(s)?(v(e,B(t,s(E)),u=>{let m=X(e,u,s);for(let l of m){a.has(u)||a.set(u,new Map),a.get(u).has(p)||a.get(u).set(p,new Set),a.get(u).get(p).add(l);let c=s(l);n.push([u,4,p,l,c])}}),v(e,$(t,s(E)),u=>{let m=a.get(u);if(m){let l=m.get(p);if(l){for(let c of l)n.push([u,5,p,c]);m.delete(p),m.size===0&&a.delete(u)}}})):(v(e,B(t,s),u=>{n.push([u,2,p])}),v(e,$(t,s),u=>{n.push([u,3,p])}))}),()=>{o=0;for(let s=0;s<n.length;s++){let[p,u,m,l,c]=n[s];y.setUint32(o,p),o+=4,y.setUint8(o,u),o+=1,(u===2||u===3||u===4||u===5)&&(y.setUint8(o,m),o+=1,(u===4||u===5)&&(y.setUint32(o,l),o+=4,u===4&&c&&(o=Y(c,p,y,o))))}return n.length=0,r.slice(0,o)}},M=(e,t,i,r)=>{let y=r||new Map;return(o,n)=>{let a=n||y,s=new DataView(o),p=0;for(;p<o.byteLength;){let u=s.getUint32(p);p+=4;let m=s.getUint8(p);p+=1;let l=-1,c=-1;(m===2||m===3||m===4||m===5)&&(l=s.getUint8(p),p+=1,(m===4||m===5)&&(c=s.getUint32(p),p+=4));let W=i[l],d=a.get(u);if(m===0)d===void 0?(d=N(e),a.set(u,d),w(e,d,t)):console.warn(`Attempted to deserialize addEntity with ID ${u}, but it has already been deserialzied and exists in the mapping.`);else if(d!==void 0&&J(e,d)){if(m===1)H(e,d),a.delete(u);else if(m===2)w(e,d,W);else if(m===3)Q(e,d,W);else if(m===4){let U=a.get(c);if(U!==void 0){let k=W(U);w(e,d,k),p=Z(k,d,s,p)}}else if(m===5){let U=a.get(c);U!==void 0&&Q(e,d,W(U))}}}return a}};function ve(e,t){let i=new WeakSet,r,y;return(o,n)=>{i.has(o)||(i.add(o),r=V(o,e[0],e),y=O(e));let a=r(),s=y(n),p=new ArrayBuffer(a.byteLength+s.byteLength),u=new Uint8Array(p);return u.set(new Uint8Array(a),0),u.set(new Uint8Array(s),a.byteLength),p}}function Ue(e){let t=new WeakSet,i,r;return(y,o,n)=>{t.has(y)||(t.add(y),i=M(y,e[0],e),r=P(e));let a=i(o,n),s=o.slice(a);return r(s,n)}}var _=(r=>(r[r.REPLACE=0]="REPLACE",r[r.APPEND=1]="APPEND",r[r.MAP=2]="MAP",r))(_||{});var ae=Symbol("$modifier");function F(e,t){let i=()=>[e,t];return i[ae]=!0,i}var De=e=>F(e,"not"),we=e=>F(e,"or"),Be=e=>F(e,"changed");function $e(e){let t=i=>re(i,e);return t.components=e,t}function Fe(e){let t=[],i=new WeakSet;return r=>{i.has(r)||(q(r,ee(...e.components),o=>t.push(o)),i.add(r));let y=t.slice();return t.length=0,y}}function ke(e){let t=[],i=new WeakSet;return r=>{i.has(r)||(q(r,te(...e.components),o=>t.push(o)),i.add(r));let y=t.slice();return t.length=0,y}}var Oe=(e,t,i)=>ne(e,i,t),Pe=(e,t,i)=>ie(e,i,t),Qe=(e,t,i)=>oe(e,i,t),Ee={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},j={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},Ve=(e,t=1e5)=>{let i=(r,y)=>{let o={};for(let n in r)if(Array.isArray(r[n])){let[a,s]=r[n];o[n]=Array.from({length:s},()=>new j[a](y))}else if(typeof r[n]=="object")o[n]=i(r[n],y);else{let a=r[n],s=j[a];if(s)o[n]=new s(y);else throw new Error(`Unsupported type: ${r[n]}`)}return o};return i(e,t)};export{ae as $modifier,Be as Changed,_ as DESERIALIZE_MODE,De as Not,we as Or,Ee as Types,Oe as addComponent,Ve as defineComponent,Ue as defineDeserializer,$e as defineQuery,ve as defineSerializer,Fe as enterQuery,ke as exitQuery,Pe as hasComponent,Qe as removeComponent};
//# sourceMappingURL=index.min.mjs.map
