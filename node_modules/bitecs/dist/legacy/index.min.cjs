var B=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames;var L=Object.prototype.hasOwnProperty;var G=(e,t)=>{for(var i in t)B(e,i,{get:t[i],enumerable:!0})},N=(e,t,i,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of q(t))!L.call(e,o)&&o!==i&&B(e,o,{get:()=>t[o],enumerable:!(r=j(t,o))||r.enumerable});return e};var H=e=>N(B({},"__esModule",{value:!0}),e);var me={};G(me,{$modifier:()=>M,Changed:()=>re,DESERIALIZE_MODE:()=>E,Not:()=>ee,Or:()=>te,Types:()=>pe,addComponent:()=>ae,defineComponent:()=>ue,defineDeserializer:()=>_,defineQuery:()=>ne,defineSerializer:()=>Z,enterQuery:()=>ie,exitQuery:()=>oe,hasComponent:()=>ye,removeComponent:()=>se});module.exports=H(me);var d=require("bitecs");var m=require("bitecs");var I=Symbol.for("bitecs-u8"),T=Symbol.for("bitecs-i8"),C=Symbol.for("bitecs-u16"),g=Symbol.for("bitecs-i16"),A=Symbol.for("bitecs-u32"),x=Symbol.for("bitecs-i32"),W=Symbol.for("bitecs-f32"),h=Symbol.for("bitecs-f64"),v=e=>(t=[])=>Object.defineProperty(t,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),ce=v(I),de=v(T),fe=v(C),be=v(g),Ae=v(A),Ie=v(x),Te=v(W),Ce=v(h),S={[I]:(e,t,i)=>(e.setUint8(t,i),1),[T]:(e,t,i)=>(e.setInt8(t,i),1),[C]:(e,t,i)=>(e.setUint16(t,i),2),[g]:(e,t,i)=>(e.setInt16(t,i),2),[A]:(e,t,i)=>(e.setUint32(t,i),4),[x]:(e,t,i)=>(e.setInt32(t,i),4),[W]:(e,t,i)=>(e.setFloat32(t,i),4),[h]:(e,t,i)=>(e.setFloat64(t,i),8)},z={[I]:(e,t)=>({value:e.getUint8(t),size:1}),[T]:(e,t)=>({value:e.getInt8(t),size:1}),[C]:(e,t)=>({value:e.getUint16(t),size:2}),[g]:(e,t)=>({value:e.getInt16(t),size:2}),[A]:(e,t)=>({value:e.getUint32(t),size:4}),[x]:(e,t)=>({value:e.getInt32(t),size:4}),[W]:(e,t)=>({value:e.getFloat32(t),size:4}),[h]:(e,t)=>({value:e.getFloat64(t),size:8})};function D(e){return e&&(ArrayBuffer.isView(e)||Array.isArray(e)&&typeof e=="object")}function w(e){for(let t of[I,T,C,g,A,x,W,h])if(t in e)return t;return e instanceof Int8Array?T:e instanceof Uint8Array?I:e instanceof Int16Array?g:e instanceof Uint16Array?C:e instanceof Int32Array?x:e instanceof Uint32Array?A:e instanceof Float32Array?W:h}var J=e=>{if(D(e)){let o=w(e),a=S[o];return(n,y,s)=>{let p=0;return p+=S[A](n,y,s),p+=a(n,y+p,e[s]),p}}let t=Object.keys(e),r=t.map(o=>{let a=e[o];if(!D(a))throw new Error(`Invalid array type for property ${o}`);return w(a)}).map(o=>S[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,a,n)=>{let y=0;y+=S[A](o,a+y,n);for(let s=0;s<t.length;s++)y+=r[s](o,a+y,e[t[s]][n]);return y}},K=e=>{if(D(e)){let o=w(e),a=z[o];return(n,y,s)=>{let p=0,{value:u,size:l}=z[A](n,y);p+=l;let c=s?s.get(u)??u:u,{value:f,size:U}=a(n,y+p);return e[c]=f,p+U}}let t=Object.keys(e),r=t.map(o=>{let a=e[o];if(!D(a))throw new Error(`Invalid array type for property ${o}`);return w(a)}).map(o=>z[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,a,n)=>{let y=0,{value:s,size:p}=z[A](o,a+y);y+=p;let u=n?n.get(s)??s:s;for(let l=0;l<t.length;l++){let{value:c,size:f}=r[l](o,a+y);e[t[l]][u]=c,y+=f}return y}},k=(e,t=new ArrayBuffer(1024*1024*100))=>{let i=new DataView(t),r=e.map(J);return o=>{let a=0;for(let n=0;n<o.length;n++){let y=o[n];for(let s=0;s<r.length;s++)a+=r[s](i,a,y)}return t.slice(0,a)}},O=e=>{let t=e.map(K);return(i,r)=>{let o=new DataView(i),a=0;for(;a<i.byteLength;)for(let n=0;n<t.length;n++)a+=t[n](o,a,r)}};function X(e,t,i,r){if(!e)return r;if(Array.isArray(e)){let o=e[t];return o!==void 0?(i.setFloat64(r,o),r+8):r}if(typeof e=="object"){let o=Object.keys(e).sort();for(let a of o){let n=e[a],y=n[t];y!==void 0&&(n instanceof Int8Array||T in n?(i.setInt8(r,y),r+=1):n instanceof Uint8Array||I in n?(i.setUint8(r,y),r+=1):n instanceof Int16Array||g in n?(i.setInt16(r,y),r+=2):n instanceof Uint16Array||C in n?(i.setUint16(r,y),r+=2):n instanceof Int32Array||x in n?(i.setInt32(r,y),r+=4):n instanceof Uint32Array||A in n?(i.setUint32(r,y),r+=4):n instanceof Float32Array||W in n?(i.setFloat32(r,y),r+=4):(i.setFloat64(r,y),r+=8))}}return r}function Y(e,t,i,r){if(!e)return r;if(Array.isArray(e))return e[t]=i.getFloat64(r),r+8;if(typeof e=="object"){let o=Object.keys(e).sort();for(let a of o){let n=e[a];n instanceof Int8Array||T in n?(n[t]=i.getInt8(r),r+=1):n instanceof Uint8Array||I in n?(n[t]=i.getUint8(r),r+=1):n instanceof Int16Array||g in n?(n[t]=i.getInt16(r),r+=2):n instanceof Uint16Array||C in n?(n[t]=i.getUint16(r),r+=2):n instanceof Int32Array||x in n?(n[t]=i.getInt32(r),r+=4):n instanceof Uint32Array||A in n?(n[t]=i.getUint32(r),r+=4):n instanceof Float32Array||W in n?(n[t]=i.getFloat32(r),r+=4):(n[t]=i.getFloat64(r),r+=8)}}return r}var P=(e,t,i,r=new ArrayBuffer(1024*1024*100))=>{let o=new DataView(r),a=0,n=[],y=new Map;return(0,m.observe)(e,(0,m.onAdd)(t),s=>{n.push([s,0,-1])}),(0,m.observe)(e,(0,m.onRemove)(t),s=>{n.push([s,1,-1]),y.delete(s)}),i.forEach((s,p)=>{(0,m.isRelation)(s)?((0,m.observe)(e,(0,m.onAdd)(t,s(m.Wildcard)),u=>{let l=(0,m.getRelationTargets)(e,u,s);for(let c of l){y.has(u)||y.set(u,new Map),y.get(u).has(p)||y.get(u).set(p,new Set),y.get(u).get(p).add(c);let f=s(c);n.push([u,4,p,c,f])}}),(0,m.observe)(e,(0,m.onRemove)(t,s(m.Wildcard)),u=>{let l=y.get(u);if(l){let c=l.get(p);if(c){for(let f of c)n.push([u,5,p,f]);l.delete(p),l.size===0&&y.delete(u)}}})):((0,m.observe)(e,(0,m.onAdd)(t,s),u=>{n.push([u,2,p])}),(0,m.observe)(e,(0,m.onRemove)(t,s),u=>{n.push([u,3,p])}))}),()=>{a=0;for(let s=0;s<n.length;s++){let[p,u,l,c,f]=n[s];o.setUint32(a,p),a+=4,o.setUint8(a,u),a+=1,(u===2||u===3||u===4||u===5)&&(o.setUint8(a,l),a+=1,(u===4||u===5)&&(o.setUint32(a,c),a+=4,u===4&&f&&(a=X(f,p,o,a))))}return n.length=0,r.slice(0,a)}},Q=(e,t,i,r)=>{let o=r||new Map;return(a,n)=>{let y=n||o,s=new DataView(a),p=0;for(;p<a.byteLength;){let u=s.getUint32(p);p+=4;let l=s.getUint8(p);p+=1;let c=-1,f=-1;(l===2||l===3||l===4||l===5)&&(c=s.getUint8(p),p+=1,(l===4||l===5)&&(f=s.getUint32(p),p+=4));let U=i[c],b=y.get(u);if(l===0)b===void 0?(b=(0,m.addEntity)(e),y.set(u,b),(0,m.addComponent)(e,b,t)):console.warn(`Attempted to deserialize addEntity with ID ${u}, but it has already been deserialzied and exists in the mapping.`);else if(b!==void 0&&(0,m.entityExists)(e,b)){if(l===1)(0,m.removeEntity)(e,b),y.delete(u);else if(l===2)(0,m.addComponent)(e,b,U);else if(l===3)(0,m.removeComponent)(e,b,U);else if(l===4){let R=y.get(f);if(R!==void 0){let F=U(R);(0,m.addComponent)(e,b,F),p=Y(F,b,s,p)}}else if(l===5){let R=y.get(f);R!==void 0&&(0,m.removeComponent)(e,b,U(R))}}}return y}};function Z(e,t){let i=new WeakSet,r,o;return(a,n)=>{i.has(a)||(i.add(a),r=P(a,e[0],e),o=k(e));let y=r(),s=o(n),p=new ArrayBuffer(y.byteLength+s.byteLength),u=new Uint8Array(p);return u.set(new Uint8Array(y),0),u.set(new Uint8Array(s),y.byteLength),p}}function _(e){let t=new WeakSet,i,r;return(o,a,n)=>{t.has(o)||(t.add(o),i=Q(o,e[0],e),r=O(e));let y=i(a,n),s=a.slice(y);return r(s,n)}}var E=(r=>(r[r.REPLACE=0]="REPLACE",r[r.APPEND=1]="APPEND",r[r.MAP=2]="MAP",r))(E||{});var M=Symbol("$modifier");function $(e,t){let i=()=>[e,t];return i[M]=!0,i}var ee=e=>$(e,"not"),te=e=>$(e,"or"),re=e=>$(e,"changed");function ne(e){let t=i=>(0,d.query)(i,e);return t.components=e,t}function ie(e){let t=[],i=new WeakSet;return r=>{i.has(r)||((0,d.observe)(r,(0,d.onAdd)(...e.components),a=>t.push(a)),i.add(r));let o=t.slice();return t.length=0,o}}function oe(e){let t=[],i=new WeakSet;return r=>{i.has(r)||((0,d.observe)(r,(0,d.onRemove)(...e.components),a=>t.push(a)),i.add(r));let o=t.slice();return t.length=0,o}}var ae=(e,t,i)=>(0,d.addComponent)(e,i,t),ye=(e,t,i)=>(0,d.hasComponent)(e,i,t),se=(e,t,i)=>(0,d.removeComponent)(e,i,t),pe={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},V={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},ue=(e,t=1e5)=>{let i=(r,o)=>{let a={};for(let n in r)if(Array.isArray(r[n])){let[y,s]=r[n];a[n]=Array.from({length:s},()=>new V[y](o))}else if(typeof r[n]=="object")a[n]=i(r[n],o);else{let y=r[n],s=V[y];if(s)a[n]=new s(o);else throw new Error(`Unsupported type: ${r[n]}`)}return a};return i(e,t)};
//# sourceMappingURL=index.min.cjs.map
